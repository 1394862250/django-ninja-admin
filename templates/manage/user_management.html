{% extends 'manage/base_admin.html' %}

{% block title %}用户管理 - {{ site_name }}{% endblock %}

{% block page_title %}用户管理{% endblock %}

{% block admin_content %}
<!-- 头部统计与操作 -->
<div class="flex flex-col md:flex-row md:items-center justify-between mb-8 space-y-4 md:space-y-0">
    <div class="flex items-center space-x-4">
        <div class="p-3 bg-primary/10 rounded-xl text-primary">
            <i class="fas fa-users-gear text-2xl"></i>
        </div>
        <div>
            <h2 class="text-2xl font-bold text-slate-800 dark:text-white">账户概览</h2>
            <p class="text-sm text-slate-500">管理系统访问权限与用户信息</p>
        </div>
    </div>
    <div class="flex items-center space-x-3">
        <button id="add-user-btn" class="inline-flex items-center px-4 py-2 bg-primary text-white text-sm font-semibold rounded-lg hover:bg-primary-hover shadow-sm transition-all">
            <i class="fas fa-plus-circle mr-2"></i>
            新增成员
        </button>
        <button id="open-seed-btn" class="inline-flex items-center px-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-sm font-semibold rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition-all">
            <i class="fas fa-flask mr-2"></i>
            数据工厂
        </button>
    </div>
</div>

<!-- 搜索与筛选 -->
<div class="modern-card p-4 mb-6">
    <div class="relative">
        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
        <input type="text" id="user-search-input" placeholder="输入用户名、昵称或邮箱搜索..." 
               class="w-full pl-11 pr-4 py-3 bg-slate-50 dark:bg-slate-900 border-none rounded-lg text-sm focus:ring-2 focus:ring-primary/20 transition-all">
    </div>
</div>

<!-- 数据工厂控制面板 (默认隐藏) -->
<div id="seed-panel" class="hidden modern-card p-6 mb-8 border-2 border-dashed border-orange-200 dark:border-orange-900/30 bg-orange-50/30 dark:bg-orange-900/5 animate-fade-in">
    <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-orange-700 dark:text-orange-400 flex items-center">
            <i class="fas fa-magic mr-2"></i> 批量数据生成
        </h3>
        <button onclick="document.getElementById('seed-panel').classList.add('hidden')" class="text-slate-400 hover:text-slate-600">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="flex flex-col md:flex-row items-end space-y-4 md:space-y-0 md:space-x-4">
        <div class="flex-1 w-full">
            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">生成数量 (1-100)</label>
            <input type="number" id="seed-count" value="10" min="1" max="100" class="modern-input w-full px-4 py-2">
        </div>
        <button id="seed-users-btn" class="w-full md:w-auto px-8 py-2 bg-orange-600 text-white rounded-lg font-bold hover:bg-orange-700 shadow-lg shadow-orange-600/20 transition-all">
            开始执行
        </button>
    </div>
    <p class="mt-4 text-[10px] text-orange-600/70 font-medium italic">注意：生成的数据将使用随机 Faker 引擎，默认密码为 password123。</p>
</div>

<!-- 用户列表 -->
<div class="modern-card overflow-hidden">
    <div id="users-loading" class="py-20 text-center">
        <div class="inline-block animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full mb-4"></div>
        <p class="text-slate-500 font-medium">载入用户数据中...</p>
    </div>

    <div id="users-table-container" class="hidden overflow-x-auto">
        <table class="w-full text-left">
            <thead>
                <tr class="bg-slate-50 dark:bg-slate-800/50 border-b border-slate-100 dark:border-slate-800">
                    <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-widest">基本信息</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-widest">状态</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-widest">权限角色</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-widest">最后活跃</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-widest text-right">操作</th>
                </tr>
            </thead>
            <tbody id="users-tbody" class="divide-y divide-slate-50 dark:divide-slate-800">
                <!-- 动态渲染 -->
            </tbody>
        </table>
    </div>
    
    <!-- 空状态 -->
    <div id="users-empty" class="hidden py-20 text-center">
        <div class="w-16 h-16 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-400">
            <i class="fas fa-user-slash text-2xl"></i>
        </div>
        <p class="text-slate-500">未找到符合条件的用户</p>
    </div>
</div>

<!-- 分页 -->
<div id="pagination-container" class="mt-8 flex justify-center items-center space-x-2"></div>

<!-- 用户表单模态框 -->
<div id="user-modal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm hidden">
    <div class="bg-white dark:bg-slate-900 rounded-modern shadow-2xl w-full max-w-lg overflow-hidden animate-slide-up">
        <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between bg-slate-50/50 dark:bg-slate-800/50">
            <h3 id="modal-title" class="font-bold text-lg">新增成员</h3>
            <button class="close-modal p-2 text-slate-400 hover:text-slate-600 transition-colors"><i class="fas fa-times"></i></button>
        </div>
        
        <form id="user-form" class="p-6 space-y-5">
            {% csrf_token %}
            <input type="hidden" id="user-id" name="user_id">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase ml-1">用户名</label>
                    <input type="text" id="username" name="username" required class="modern-input w-full px-4 py-2.5" placeholder="登录账号">
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase ml-1">昵称</label>
                    <input type="text" id="nickname" name="nickname" class="modern-input w-full px-4 py-2.5" placeholder="显示名称">
                </div>
            </div>

            <div class="space-y-2">
                <label class="text-xs font-bold text-slate-500 uppercase ml-1">电子邮箱</label>
                <input type="email" id="email" name="email" required class="modern-input w-full px-4 py-2.5" placeholder="user@example.com">
            </div>

            <div class="space-y-2" id="password-section">
                <label class="text-xs font-bold text-slate-500 uppercase ml-1">设置密码</label>
                <input type="password" id="password" name="password" class="modern-input w-full px-4 py-2.5" placeholder="••••••••">
                <p class="text-[10px] text-slate-400 italic ml-1" id="pass-hint">编辑时留空则不修改密码</p>
            </div>

            <div class="grid grid-cols-2 gap-5 pt-2">
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase ml-1">账号状态</label>
                    <select id="is-active" name="is_active" class="modern-input w-full px-4 py-2.5 appearance-none">
                        <option value="true">激活</option>
                        <option value="false">禁用</option>
                    </select>
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase ml-1">管理权限</label>
                    <select id="is-staff" name="is_staff" class="modern-input w-full px-4 py-2.5 appearance-none">
                        <option value="false">普通成员</option>
                        <option value="true">管理员</option>
                    </select>
                </div>
            </div>

            <div class="mt-8 flex items-center justify-end space-x-3 pt-4">
                <button type="button" class="close-btn px-6 py-2.5 text-sm font-bold text-slate-500 hover:text-slate-700 transition-colors">取消</button>
                <button type="submit" class="px-8 py-2.5 bg-primary text-white rounded-lg font-bold hover:bg-primary-hover shadow-lg shadow-orange-600/20 transition-all">保存更改</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = 1;
    let currentSearch = '';

    // 适配新 API 的请求函数
    async function request(url, options = {}) {
        const res = await fetch(url, {
            ...options,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
                ...options.headers
            }
        });
        const result = await res.json();
        if (!result.success) throw new Error(result.message || '操作失败');
        return result.data;
    }

    // 定义 Toast 快捷方式，适配 alert_components.html
    const Toast = {
        fire: (options) => {
            if (window.showToast) {
                window.showToast(options.title, options.icon);
            } else {
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    ...options
                });
            }
        }
    };

    // 加载数据
    async function loadUsers(page = 1) {
        const loading = document.getElementById('users-loading');
        const container = document.getElementById('users-table-container');
        const empty = document.getElementById('users-empty');
        const tbody = document.getElementById('users-tbody');
        
        loading.classList.remove('hidden');
        container.classList.add('hidden');
        empty.classList.add('hidden');

        try {
            const data = await request(`/api/manage/users?page=${page}&search=${encodeURIComponent(currentSearch)}`);
            const users = data.users || [];
            
            if (users.length === 0) {
                empty.classList.remove('hidden');
            } else {
                tbody.innerHTML = users.map(user => `
                    <tr data-user-id="${user.id}" class="hover:bg-slate-50/50 dark:hover:bg-slate-800/30 transition-all group">
                        <td class="px-6 py-4">
                            <div class="flex items-center space-x-4">
                                <div class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 flex-shrink-0 flex items-center justify-center overflow-hidden border border-slate-200 dark:border-slate-700">
                                    ${user.profile?.avatar ? `<img src="${user.profile.avatar}" class="w-full h-full object-cover">` : `<span class="text-slate-400 font-bold">${user.username.charAt(0).toUpperCase()}</span>`}
                                </div>
                                <div class="min-w-0">
                                    <p class="text-sm font-bold text-slate-800 dark:text-slate-200 truncate">${user.profile?.nickname || user.username}</p>
                                    <p class="text-xs text-slate-400 truncate">${user.email || '无邮箱'}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            ${user.is_active 
                                ? '<span class="px-2 py-1 text-[10px] font-bold uppercase tracking-wider bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400 rounded-md">Active</span>' 
                                : '<span class="px-2 py-1 text-[10px] font-bold uppercase tracking-wider bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400 rounded-md">Disabled</span>'}
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-[10px] font-bold uppercase tracking-wider bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-400 rounded-md border border-slate-200 dark:border-slate-700">
                                ${user.is_staff ? 'Administrator' : 'Standard User'}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <p class="text-xs text-slate-500 font-medium">${user.profile?.last_activity ? new Date(user.profile.last_activity).toLocaleString() : '从未登录'}</p>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex items-center justify-end space-x-1">
                                <button onclick="editUser('${user.id}')" class="p-2 text-slate-400 hover:text-primary transition-colors"><i class="fas fa-pen-to-square"></i></button>
                                <button onclick="toggleStatus('${user.id}')" class="p-2 ${user.is_active ? 'text-slate-400 hover:text-orange-500' : 'text-slate-400 hover:text-green-500'} transition-colors"><i class="fas fa-power-off"></i></button>
                                <button onclick="deleteUser('${user.id}')" class="p-2 text-slate-400 hover:text-red-500 transition-colors"><i class="fas fa-trash-can"></i></button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                container.classList.remove('hidden');
                renderPagination(data.page, data.total_pages);
            }
        } catch (e) {
            Toast.fire({ icon: 'error', title: e.message });
        } finally {
            loading.classList.add('hidden');
        }
    }

    function renderPagination(page, total) {
        const wrap = document.getElementById('pagination-container');
        if (total <= 1) { wrap.innerHTML = ''; return; }
        
        let html = `
            <button onclick="changePage(${page-1})" ${page === 1 ? 'disabled' : ''} class="p-2 rounded-lg bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 disabled:opacity-30"><i class="fas fa-chevron-left"></i></button>
            <span class="px-4 text-xs font-bold text-slate-500 uppercase">Page ${page} of ${total}</span>
            <button onclick="changePage(${page+1})" ${page === total ? 'disabled' : ''} class="p-2 rounded-lg bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 disabled:opacity-30"><i class="fas fa-chevron-right"></i></button>
        `;
        wrap.innerHTML = html;
    }

    window.changePage = (p) => { currentPage = p; loadUsers(p); };

    // 搜索
    let searchTimer;
    document.getElementById('user-search-input').addEventListener('input', (e) => {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => {
            currentSearch = e.target.value;
            currentPage = 1;
            loadUsers(1);
        }, 500);
    });

    // 控制面板切换
    document.getElementById('open-seed-btn').addEventListener('click', () => {
        document.getElementById('seed-panel').classList.toggle('hidden');
    });

    // 数据工厂执行
    document.getElementById('seed-users-btn').addEventListener('click', async () => {
        const count = document.getElementById('seed-count').value;
        const btn = document.getElementById('seed-users-btn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>生成中...';
        
        try {
            await request('/api/manage/users/seed', {
                method: 'POST',
                body: JSON.stringify({ count: parseInt(count), default_password: 'password123' })
            });
            Toast.fire({ icon: 'success', title: '数据生成成功' });
            loadUsers(1);
        } catch (e) {
            Toast.fire({ icon: 'error', title: e.message });
        } finally {
            btn.disabled = false;
            btn.innerHTML = '开始执行';
        }
    });

    // 弹窗逻辑
    const modal = document.getElementById('user-modal');
    window.editUser = async (id) => {
        try {
            const data = await request(`/api/manage/users/${id}`);
            document.getElementById('user-id').value = data.id;
            document.getElementById('username').value = data.username;
            document.getElementById('nickname').value = data.profile?.nickname || '';
            document.getElementById('email').value = data.email;
            document.getElementById('is-active').value = data.is_active.toString();
            document.getElementById('is-staff').value = data.is_staff.toString();
            document.getElementById('password').value = '';
            document.getElementById('modal-title').textContent = '编辑成员信息';
            modal.classList.remove('hidden');
        } catch(e) { Toast.fire({ icon: 'error', title: e.message }); }
    };

    document.getElementById('add-user-btn').addEventListener('click', () => {
        document.getElementById('user-id').value = '';
        document.getElementById('user-form').reset();
        document.getElementById('modal-title').textContent = '新增成员';
        modal.classList.remove('hidden');
    });

    document.querySelectorAll('.close-modal, .close-btn').forEach(b => b.addEventListener('click', () => modal.classList.add('hidden')));

    document.getElementById('user-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('user-id').value;
        const body = {
            username: document.getElementById('username').value,
            nickname: document.getElementById('nickname').value || null,
            email: document.getElementById('email').value,
            is_active: document.getElementById('is-active').value === 'true',
            is_staff: document.getElementById('is-staff').value === 'true'
        };
        const pass = document.getElementById('password').value;
        if (pass) body.password = pass;

        try {
            await request(id ? `/api/manage/users/${id}` : '/api/manage/users', {
                method: id ? 'PUT' : 'POST',
                body: JSON.stringify(body)
            });
            Toast.fire({ icon: 'success', title: '保存成功' });
            modal.classList.add('hidden');
            loadUsers(currentPage);
        } catch(e) { Toast.fire({ icon: 'error', title: e.message }); }
    });

    window.toggleStatus = async (id) => {
        if (!await confirmSwal('确定要切换该账号的活动状态吗？')) return;
        try {
            const data = await request(`/api/manage/users/${id}/toggle-status`, { method: 'POST' });
            Toast.fire({ icon: 'success', title: '状态已更新' });
            
            // 软刷新：通过 data-user-id 定位行
            const row = document.querySelector(`tr[data-user-id="${id}"]`);
            if (row) {
                const statusCell = row.cells[1];
                const isActive = data.is_active;
                statusCell.innerHTML = isActive 
                    ? '<span class="px-2 py-1 text-[10px] font-bold uppercase tracking-wider bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400 rounded-md">Active</span>' 
                    : '<span class="px-2 py-1 text-[10px] font-bold uppercase tracking-wider bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400 rounded-md">Disabled</span>';
                
                const btn = row.querySelector('button[onclick*="toggleStatus"]');
                if (btn) {
                    btn.className = `p-2 ${isActive ? 'text-slate-400 hover:text-orange-500' : 'text-slate-400 hover:text-green-500'} transition-colors`;
                }
            } else {
                // 兜底：如果找不到行，直接刷新当前页
                loadUsers(currentPage);
            }
        } catch(e) { 
            console.error('Toggle status error:', e);
            Toast.fire({ icon: 'error', title: e.message }); 
        }
    };

    window.deleteUser = async (id) => {
        if (!await confirmSwal('确定要删除该成员吗？此操作无法撤销。', 'warning')) return;
        try {
            await request(`/api/manage/users/${id}`, { method: 'DELETE' });
            Toast.fire({ icon: 'success', title: '成员已移除' });
            
            const row = document.querySelector(`tr[data-user-id="${id}"]`);
            if (row) {
                row.classList.add('opacity-0', 'translate-x-4', 'transition-all', 'duration-300');
                setTimeout(() => {
                    row.remove();
                    const remainingRows = document.getElementById('users-tbody').children.length;
                    if (remainingRows === 0) {
                        loadUsers(currentPage > 1 ? currentPage - 1 : 1);
                    }
                }, 300);
            } else {
                loadUsers(currentPage);
            }
        } catch(e) { 
            console.error('Delete user error:', e);
            Toast.fire({ icon: 'error', title: e.message }); 
        }
    };

    async function confirmSwal(text, icon = 'question') {
        const res = await Swal.fire({
            title: '确认操作',
            text: text,
            icon: icon,
            showCancelButton: true,
            confirmButtonColor: '#ea580c',
            cancelButtonColor: '#64748b',
            confirmButtonText: '确定',
            cancelButtonText: '取消',
            background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
            color: document.documentElement.classList.contains('dark') ? '#fff' : '#000',
        });
        return res.isConfirmed;
    }

    loadUsers();
});
</script>
{% endblock %}
