<!-- 修改密码模态框组件 -->
<div id="change-password-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-slide-up border border-slate-100 dark:border-slate-800">
        <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between bg-slate-50/50 dark:bg-slate-800/50">
            <div>
                <h3 class="font-bold text-lg text-slate-800 dark:text-white">修改登录密码</h3>
                <p class="text-[10px] text-slate-400 uppercase font-bold tracking-widest mt-0.5">Change Security Password</p>
            </div>
            <button class="change-password-close-modal p-2 text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="change-password-form" class="p-6 space-y-6">
            {% csrf_token %}
            <div class="space-y-5">
                <div class="space-y-2">
                    <label for="old_password" class="text-[10px] font-bold text-slate-500 uppercase ml-1">当前密码</label>
                    <div class="relative">
                        <i class="fas fa-lock-open absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                        <input type="password" id="old_password" name="old_password" required
                               class="modern-input w-full pl-10 pr-4 py-2.5" placeholder="请输入当前使用的密码">
                    </div>
                </div>
                
                <div class="space-y-2">
                    <label for="new_password1" class="text-[10px] font-bold text-slate-500 uppercase ml-1">设置新密码</label>
                    <div class="relative">
                        <i class="fas fa-key absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                        <input type="password" id="new_password1" name="new_password1" required
                               class="modern-input w-full pl-10 pr-4 py-2.5" placeholder="至少 8 位字符">
                    </div>
                </div>
                
                <div class="space-y-2">
                    <label for="new_password2" class="text-[10px] font-bold text-slate-500 uppercase ml-1">确认新密码</label>
                    <div class="relative">
                        <i class="fas fa-shield-check absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                        <input type="password" id="new_password2" name="new_password2" required
                               class="modern-input w-full pl-10 pr-4 py-2.5" placeholder="请再次输入新密码">
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">安全验证</label>
                    <div class="flex items-center space-x-3">
                        <input type="text" id="change-password-captcha" name="captcha" required placeholder="验证码"
                               class="modern-input flex-1 px-4 py-2.5">
                        <div class="relative group flex-shrink-0">
                            <img id="change-password-captcha-image" src="" alt="验证码" 
                                 class="h-[42px] w-28 rounded-lg border border-slate-200 dark:border-slate-700 cursor-pointer object-cover"
                                 onclick="refreshChangePasswordCaptcha()" title="点击刷新">
                            <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 flex items-center justify-center pointer-events-none transition-opacity rounded-lg">
                                <i class="fas fa-arrows-rotate text-white text-xs"></i>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="change-password-captcha-key" name="captcha_key">
                </div>
            </div>
            
            <div class="flex items-center justify-end space-x-3 pt-4 border-t border-slate-100 dark:border-slate-800">
                <button type="button" class="change-password-close-btn px-6 py-2.5 text-sm font-bold text-slate-500 hover:text-slate-700 transition-colors">取消</button>
                <button type="submit" class="px-8 py-2.5 bg-primary text-white rounded-lg font-bold hover:bg-primary-hover shadow-lg shadow-orange-600/20 transition-all flex items-center">
                    <i class="fas fa-check-double mr-2"></i>确认修改
                </button>
            </div>
        </form>
    </div>
</div>

<script>
(function() {
    const modal = document.getElementById('change-password-modal');
    const form = document.getElementById('change-password-form');
    const closeBtns = modal.querySelectorAll('.change-password-close-modal, .change-password-close-btn');
    
    const Toast = {
        fire: (options) => {
            if (window.showToast) window.showToast(options.title, options.icon);
            else Swal.fire({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true, ...options });
        }
    };

    function toggleModal(show) {
        if (show) {
            modal.classList.remove('hidden');
            refreshChangePasswordCaptcha();
        } else {
            modal.classList.add('hidden');
            form.reset();
        }
    }
    
    window.refreshChangePasswordCaptcha = async function() {
        try {
            const res = await fetch('/api/user/change-password', { credentials: 'same-origin' });
            const result = await res.json();
            if (result.success && result.data) {
                document.getElementById('change-password-captcha-image').src = result.data.captcha_image_url;
                document.getElementById('change-password-captcha-key').value = result.data.captcha_key;
            }
        } catch (e) { Toast.fire({ icon: 'error', title: '获取验证码失败' }); }
    };
    
    closeBtns.forEach(btn => btn.addEventListener('click', () => toggleModal(false)));
    modal.addEventListener('click', (e) => e.target === modal && toggleModal(false));
    
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const p1 = document.getElementById('new_password1').value;
        const p2 = document.getElementById('new_password2').value;
        
        if (p1.length < 8) { Toast.fire({ icon: 'error', title: '密码长度至少8位' }); return; }
        if (p1 !== p2) { Toast.fire({ icon: 'error', title: '两次输入的密码不一致' }); return; }
        
        const btn = form.querySelector('button[type="submit"]');
        const original = btn.innerHTML;
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>处理中...';
        
        const payload = {
            old_password: document.getElementById('old_password').value,
            new_password1: p1,
            new_password2: p2,
            captcha: document.getElementById('change-password-captcha').value,
            captcha_key: document.getElementById('change-password-captcha-key').value
        };
        
        try {
            const res = await fetch('/api/user/change-password', {
                method: 'POST', body: JSON.stringify(payload), credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') }
            });
            const data = await res.json();
            if (data.success) {
                Toast.fire({ icon: 'success', title: '密码已修改，请重新登录' });
                toggleModal(false);
                setTimeout(() => window.location.href = '{% url "web:login" %}', 1500);
            } else {
                Toast.fire({ icon: 'error', title: data.message });
                refreshChangePasswordCaptcha();
            }
        } catch (e) { 
            Toast.fire({ icon: 'error', title: '网络请求失败' }); 
            refreshChangePasswordCaptcha();
        } finally { btn.disabled = false; btn.innerHTML = original; }
    });
    
    window.openChangePasswordModal = () => toggleModal(true);
})();
</script>
